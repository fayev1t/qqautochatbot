一个基于 **NAPCAT + NONEBOT** 的 QQ 机器人框架，**核心设计目标是实现机器人在群聊中自然、灵活地参与对话**。

具体在于：机器人怎样才能知道什么时候该说话、说多少。传统的 QQ 机器人要么需要被@才能响应，要么会对每条消息都回复，显得生硬刻板。我的解决方案是先用消息聚合机制动态地收集一段时间内相关的消息，而不是逐条处理，这样既能避免对用户连发的多条消息做重复回复，也能避免被刷屏干扰。然后让 AI 根据消息的完整性、用户的历史行为模式、时间间隔等维度智能判断应该等待一定时间还是立即处理。消息聚合完成后，再调用另一层 AI 分析整个对话块的内容和群聊背景，判断是否值得回复、需要回复几次、用什么态度回复。最后根据这些判断生成实际的回复内容。整个过程中，会利用数据库存储的历史消息来提供充分的上下文，群友昵称，群友事件等信息，让 AI 更好地理解用户特点和群聊节奏。这样机器人就能像真正的群友一样，既不显得冷漠，也不会过度插话。

此外我也会添加更多的机器人功能、多模态效果以及爬虫功能，完善它的机器人属性。
同时特别感谢 **NAPCAT** 和 **NONEBOT** 两个优秀的开源项目，让我可以专注于对话逻辑、数据库以及其他功能的开发。

---

## 🎯 核心设计思路

**问题描述**：机器人如何在群聊中自然、灵活地参与对话，而不是简单地调用 AI 进行独立回复？

这个项目的核心不是构建一个"问就回答"的对话系统，而是实现一个完整的**群聊理解与参与系统**。它需要理解群聊的动态、识别用户的交互模式、记录群内的重要事件，并基于这些深层次的上下文进行智能决策。

**关键挑战**：
- 用户会分多条消息发表同一个观点，机器人不应该逐条回复
- 群聊中充满各种信息和事件，不是所有消息都值得回应
- 刷屏、表情包等噪音需要被识别和过滤
- 回复的时机和方式要考虑用户关系、群聊背景、历史交互模式
- 需要追踪群友昵称变化、群成员变动、重要事件等信息，为 AI 决策提供完整的群聊画像

**解决方案**：通过**动态消息聚合 + 群聊状态管理 + 多层智能判断**

1. **群聊状态与数据基础**
   - 实时维护群友信息库：群友 QQ 号、昵称、群内卡片等身份标识
   - 事件驱动记录：成员加入/退出、群公告、禁言等群事件
   - 历史上下文：存储消息历史、用户行为模式、话题趋势等
   - 这些数据为 AI 决策提供充分的群聊背景

2. **消息聚合阶段**
   - 收到第一条消息时创建"消息块"，设置等待计时器
   - 在等待期间继续收集相关消息
   - 如果 AI 判断消息已表达完整，立即停止等待
   - 如果新消息到达，AI 重新评估应该继续等待还是立即处理

3. **等待时间判断**（第一层 AI）
   - 输入：当前消息块、消息时间、用户历史发言模式、群聊活跃度
   - 判断维度：消息完整性、用户连发习惯、群聊状态、特殊信号（@、问号等）
   - 输出：应该立即处理（0秒）还是等待（3-10秒动态决定）
   - 目的：在用户还在继续表达时不打断，用户表达完整时及时响应

4. **对话块判断**（第二层 AI）
   - 输入：完整的消息块、历史对话上下文、群友信息、群内事件记录
   - 判断：这个消息块是否值得回复 → 如果值得，要回复几次 → 每次回复的类型和态度
   - 考虑因素：话题的相关性、相关用户的身份和关系、群聊背景、机器人的性格定位、群内最近的事件和状态
   - 输出：回复计划列表（类型、情感、指导信息等）

5. **内容生成**（第三层 AI）
   - 根据回复计划逐条生成具体的回复内容
   - 结合角色人设、完整对话背景、群友信息、群内事件，确保回复自然连贯
   - 多次回复之间间隔发送，避免突兀

**技术特点**：
- 异步并行处理：旧消息块在处理回复时，新消息可以创建新块进行聚合
- 动态调整：等待时间不固定，每次都基于当前消息特征重新判断
- 群聊感知：融合群友身份、群内事件、历史模式等多维度信息，让决策更符合群聊实际
- 上下文完整：不仅存储消息，还管理群友信息、事件记录、用户行为模式等多层次数据
- 可调优：所有 AI 判断逻辑都通过集中管理的提示词控制，便于迭代优化



## 🏗️ 技术架构

### 群聊处理流程

```
QQ 消息入口
    │
    ▼
消息聚合器 (MessageAggregator)
    │
    ├─→ [新消息] 添加到消息块
    │
    ├─→ 【第一层 AI】等待时间判断
    │   ├─ 输入：消息块 + 历史对话 + 用户模式 + 群状态
    │   ├─ 判断：应该等待还是立即处理？
    │   └─ 输出：should_wait, wait_seconds
    │
    ├─→ 等待 N 秒（或 0 秒）
    │
    └─→ 【第二层 AI】对话块判断 (BlockJudger)
        ├─ 输入：完整消息块 + 历史上下文 + 用户信息 + 群事件
        ├─ 判断：需要回复吗？回复几次？什么类型？
        └─ 输出：should_reply, reply_count, reply_plans
            │
            ├─ 对每个回复计划：
            │   └─→ 【第三层 AI】对话生成 (ConversationService)
            │       ├─ 输入：回复计划指导 + 完整上下文 + 群友信息
            │       └─ 输出：具体的回复内容
            │
            └─→ 发送消息 + 存储到数据库
```

### 数据库事件驱动系统

```
┌─────────────────────────────────────────────────────────────┐
│ 实时事件源                                                  │
└─────────────────────────────────────────────────────────────┘
    │
    ├─→ 群消息事件 ──→ 消息表 (存储 + 用户行为分析)
    │
    ├─→ 群成员变动 ──→ 群友表 (更新成员状态 + 事件标记)
    │   ├─ 成员加入
    │   └─ 成员移除
    │
    ├─→ 群信息变化 ──→ 群组表 (昵称变化、群公告等)
    │   ├─ 群友昵称/卡片更新
    │   ├─ 群公告发布
    │   └─ 群名称变更
    │
    └─→ 群管理事件 ──→ 事件表 (记录重要事件)
        ├─ 禁言处理
        ├─ 权限变更
        └─ 其他管理操作

    ↓

┌─────────────────────────────────────────────────────────────┐
│ AI 决策层数据查询                                            │
│ (等待时间判断 → 对话块判断 → 内容生成)                      │
└─────────────────────────────────────────────────────────────┘
    │
    ├─ 获取用户历史行为模式 (分析发言频率、连发习惯)
    ├─ 获取群聊状态 (当前活跃度、最近事件)
    ├─ 查询相关用户身份 (昵称、群内卡片、历史关系)
    └─ 提取话题上下文 (最近30条消息、相关用户、事件背景)

    ↓

    基于完整的群聊画像进行智能决策
```

数据库不仅存储历史数据，还通过事件驱动机制：
- **用户识别**：通过 QQ 号作为唯一标识符，实时同步群友昵称、卡片等身份信息
- **行为分析**：记录用户的发言模式、活跃时间段、与其他用户的互动等
- **事件跟踪**：捕捉群成员变动、重要公告、管理操作等，用于理解群聊的变化
- **上下文构建**：在 AI 进行决策时，聚合相关的历史数据、用户关系、群内背景
- **决策优化**：AI 根据这些多维度的数据进行更精准的等待时间判断和回复决策

### 核心数据流

```
消息块状态：
┌────────────────────────────────────────┐
│ ResponseBlock                          │
├────────────────────────────────────────┤
│ messages: [msg1, msg2, msg3...]       │ ← 聚合的消息
│ created_at: timestamp                 │ ← 块创建时间
│ last_message_at: timestamp            │ ← 最后一条消息时间
│ wait_judgment_done: bool              │ ← 等待判断是否完成
│ expected_wait_time: float             │ ← AI 判断的等待时间
│ is_processing: bool                   │ ← 是否正在处理
└────────────────────────────────────────┘
        │
        ▼ (等待判断 API + 数据库查询)
    [should_wait, wait_seconds]
        │
        ├─ false → 立即处理（0秒）
        └─ true → 等待 N 秒后处理
```

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **群聊决策** | LangChain + DeepSeek/OpenAI | 三层 AI 决策系统 |
| **消息聚合** | AsyncIO + 任务管理 | 动态消息块和等待控制 |
| **框架基础** | NoneBot2 v2.4+ | 异步事件驱动框架 |
| **QQ 协议** | OneBot V11 | QQ 通信标准协议 |
| **数据存储** | PostgreSQL + SQLAlchemy | 上下文和历史消息 |
| **异步支持** | asyncpg | 异步数据库驱动 |

---

## 📂 项目结构

```
qqbot/
├── qqbot/
│   ├── plugins/
│   │   ├── group_chat.py               # ⭐ 群聊处理核心（消息聚合、多层AI）
│   │   └── event_handlers.py           # 事件处理和消息保存
│   │
│   ├── services/
│   │   ├── message_aggregator.py       # ⭐ 消息聚合引擎
│   │   ├── block_judge.py              # ⭐ 第二层：对话块判断 AI
│   │   ├── prompt.py                   # ⭐ 提示词管理（包括等待判断、块判断、回复生成）
│   │   ├── conversation.py             # 第三层：对话生成 AI
│   │   ├── context.py                  # 上下文管理（历史消息、用户模式）
│   │   └── [其他服务]                  # 数据库操作、缓存等支持功能
│   │
│   ├── core/
│   │   ├── database.py                 # 数据库连接管理
│   │   ├── llm.py                      # LLM 配置
│   │   └── [其他基础]
│   │
│   └── [模型、工具、配置等]
│
├── pyproject.toml
├── .env, .env.dev, .env.prod
├── CLAUDE.md
├── README.md                           # 本文件
└── logs/
```

---

## 🚀 快速开始

### 前置条件
- Python 3.9+
- PostgreSQL 容器化部署
- napcat Docker 容器化部署

### 环境配置

创建 `.env.dev`：
```env
# NoneBot2 配置
ENVIRONMENT=dev
DRIVER=~fastapi
HOST=0.0.0.0
PORT=8080
ONEBOT_ACCESS_TOKEN=your_token

# LLM 配置（群聊决策的 AI）
LLM_PROVIDER=deepseek
LLM_API_KEY=sk-xxx
LLM_MODEL=deepseek-chat
LLM_TEMPERATURE=0.5

# 数据库配置（存储历史消息用于决策）
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/qqbot

# 日志
LOG_LEVEL=DEBUG
```

### 启动

```bash
# 安装依赖
pip install -e ".[dev]"

# 启动开发模式
nb run --reload
```

---

## 🔄 工作阶段规划

### Phase 1: 群聊参与逻辑完善 ✅ (进行中)
- [x] 消息聚合系统实现
- [x] 等待时间 AI 判断（3-10秒动态决策）
- [x] 对话块多层 AI 分析
- [x] 沉默模式
- [ ] 群员事件记录
- [ ] 群聊内容知识库转化
......
### Phase 2: 群聊交互增强 📋
- [ ] 特殊场景处理（投票、讨论等）
- [ ] 群事件监控与控制
- [ ] 定点爬虫

......
### Phase 3: 多模态能力 📚
- [ ] 实时网络搜索
- [ ] MCP 接口扩展
- [ ] 多模态理解（图像识别）
.....
### Phase 4: 生产部署 🚀
- [ ] 性能优化
- [ ] Docker 打包
- [ ] 部署文档
- [ ] 发行版管理

---

## 📄 许可证

无

